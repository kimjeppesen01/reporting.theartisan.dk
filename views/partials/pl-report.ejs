<!-- KPI Hero Cards -->
<div class="kpi-row">
  <div class="kpi-card revenue">
    <div class="kpi-label">Revenue</div>
    <div class="kpi-value"><%= formatCurrency(activeRevenue) %></div>
    <div class="kpi-delta <%= revenueTrend === 'up' ? 'positive' : revenueTrend === 'down' ? 'negative' : 'neutral' %>">
      <% if (prevActiveRevenue > 0) { %>
        <%= revenueTrend === 'up' ? 'â†‘' : revenueTrend === 'down' ? 'â†“' : 'â†’' %>
        <%= formatPercent(Math.abs((activeRevenue - prevActiveRevenue) / prevActiveRevenue * 100)) %> vs last period
      <% } else { %>
        â€” first period
      <% } %>
    </div>
  </div>

  <div class="kpi-card costs">
    <div class="kpi-label">Total Costs</div>
    <div class="kpi-value"><%= formatCurrency(totalCosts) %></div>
    <div class="kpi-delta <%= costTrend === 'up' ? 'negative' : costTrend === 'down' ? 'positive' : 'neutral' %>">
      <% if (prevTotalCosts > 0) { %>
        <%= costTrend === 'up' ? 'â†‘' : costTrend === 'down' ? 'â†“' : 'â†’' %>
        <%= formatPercent(Math.abs((totalCosts - prevTotalCosts) / prevTotalCosts * 100)) %> vs last period
      <% } else { %>
        â€” first period
      <% } %>
    </div>
  </div>

  <div class="kpi-card profit">
    <div class="kpi-label">Gross Profit</div>
    <div class="kpi-value <%= grossProfit >= 0 ? 'positive' : 'negative' %>"><%= formatCurrency(grossProfit) %></div>
    <div class="kpi-delta <%= profitTrend === 'up' ? 'positive' : profitTrend === 'down' ? 'negative' : 'neutral' %>">
      <% if (activeRevenue > 0) { %>
        Margin: <strong><%= formatPercent(profitMargin) %></strong>
      <% } else { %>
        â€” no revenue
      <% } %>
    </div>
  </div>
</div>

<!-- Waterfall Chart -->
<% if (activeRevenue > 0 || totalCosts > 0) { %>
<div class="chart-card">
  <div class="chart-card-header">P&L Waterfall</div>
  <div class="waterfall-container">
    <canvas id="waterfallChart"></canvas>
  </div>
</div>
<% } %>

<!-- Operating Expenses donut -->
<% if (activeCostKeys.length > 0 && totalCosts > 0) { %>
<%
  const DONUT_COLORS = ['#1e3a5f','#0ea5e9','#16a34a','#d97706','#7c3aed','#ec4899'];
  const donutGroups = activeCostKeys
    .map(k => groups[k])
    .filter(g => g && g.total > 0);
  const donutData = {
    labels: donutGroups.map(g => g.label),
    values: donutGroups.map(g => g.total),
    colors: donutGroups.map((_, i) => DONUT_COLORS[i % DONUT_COLORS.length]),
    total:  totalCosts,
  };
%>
<div class="opex-section">
  <div class="opex-header">Operating Expenses</div>
  <div class="opex-card">
    <div class="opex-donut-wrap">
      <canvas id="opexDonut"></canvas>
      <div class="opex-donut-center">
        <span class="opex-donut-label">Total</span>
        <span class="opex-donut-total"><%= formatCurrency(totalCosts) %></span>
      </div>
    </div>
    <div class="opex-legend">
      <% donutGroups.forEach(function(g, i) { %>
        <% const pct = totalCosts > 0 ? (g.total / totalCosts * 100) : 0; %>
        <div class="opex-legend-item">
          <div class="opex-dot" style="background:<%= DONUT_COLORS[i % DONUT_COLORS.length] %>"></div>
          <div class="opex-legend-body">
            <div class="opex-legend-top">
              <span class="opex-legend-name"><%= g.label %></span>
              <span class="opex-legend-amount"><%= formatCurrency(g.total) %></span>
            </div>
            <div class="opex-mini-bar-wrap">
              <div class="opex-mini-bar" style="background:<%= DONUT_COLORS[i % DONUT_COLORS.length] %>;width:<%= Math.min(pct,100) %>%"></div>
            </div>
            <p class="opex-legend-pct"><%= formatPercent(pct) %> of total</p>
          </div>
        </div>
      <% }); %>
    </div>
  </div>
</div>
<script id="opex-donut-data" type="application/json"><%- JSON.stringify(donutData) %></script>
<% } %>

<!-- No-cost tabs info card -->
<% if (activeCostKeys.length === 0) { %>
<div class="info-card">
  <div class="info-icon"><%= tab === 'events' ? 'ðŸŽª' : 'ðŸ“Š' %></div>
  <div class="info-text">
    <strong><%= tab === 'events' ? 'Events' : 'Revenue' %>: <%= formatCurrency(activeRevenue) %></strong><br>
    Cost attribution for this stream is not yet configured.
  </div>
</div>
<% } %>

<!-- Cost Group Cards -->
<% if (activeCostKeys.length > 0) { %>
<div class="cost-groups">
  <div class="cost-groups-header">Cost Breakdown</div>

  <% Object.entries(groups).forEach(([groupKey, group]) => { %>
    <% if (!activeCostKeys.includes(groupKey)) return; %>
    <% if (groupKey !== 'labour' && group.total === 0 && Object.keys(group.categories).length === 0) return; %>
    <%
      const delta = costDeltaPct(groupKey);
      const health = delta > 20 ? 'red' : delta > 0 ? 'amber' : 'green';
      const pct = totalCosts > 0 ? (group.total / totalCosts * 100) : 0;
    %>
    <div class="cost-group health-<%= health %>" data-group="<%= groupKey %>">
      <div class="cost-group-header" onclick="toggleGroup('<%= groupKey %>')">
        <div class="cost-group-left">
          <span class="cost-group-icon"><%= group.icon %></span>
          <span class="cost-group-label"><%= group.label %></span>
          <% if (groupKey === 'fixed' && group._rawTotal > 0 && group._tabPct < 1) { %>
            <span class="alloc-badge"><%= Math.round((group._tabPct || 0) * 100) %>% of total</span>
          <% } %>
        </div>
        <div class="cost-group-right">
          <div class="cost-group-bar-wrap">
            <div class="cost-group-bar" style="width:<%= Math.min(pct, 100) %>%"></div>
          </div>
          <span class="cost-group-total"><%= formatCurrency(group.total) %></span>
          <span class="cost-group-chevron" id="chevron-<%= groupKey %>">â–¶</span>
        </div>
      </div>

      <div class="cost-group-body" id="body-<%= groupKey %>" style="display:none">
        <% if (groupKey === 'labour') { %>
          <% if (group._rawTotal > 0) { %>
            <div class="labour-dash-meta">
              All payroll (14xx): <strong><%= formatCurrency(group._rawTotal) %></strong>
              <% if (group._deduction > 0) { %>
                &middot; Deduction: <strong style="color:#ef4444">âˆ’<%= formatCurrency(group._deduction) %></strong>
                &middot; Net: <strong><%= formatCurrency(group._netTotal) %></strong>
              <% } %>
              &middot; This tab: <strong><%= formatCurrency(group.total) %></strong>
            </div>
          <% } else { %>
            <div class="labour-dash-meta labour-dash-nodata">
              No payroll data for 14xx accounts this period.
            </div>
          <% } %>
          <% if (labourProjected > 0) { %>
            <div class="labour-projection">
              Projected full month: <strong><%= formatCurrency(labourProjected) %></strong>
              <span class="labour-projection-note">(based on last month)</span>
            </div>
          <% } %>
          <% if (Object.keys(group.categories).length > 0) { %>
            <% Object.entries(group.categories).forEach(([catName, catData]) => { %>
              <% const catPct = group.total > 0 ? (catData.total / group.total * 100) : 0; %>
              <div class="cost-category">
                <div class="cost-category-header">
                  <span class="cost-category-name"><%= catName %></span>
                  <div class="cost-category-right">
                    <div class="mini-bar-wrap">
                      <div class="mini-bar" style="width:<%= Math.min(catPct, 100) %>%"></div>
                    </div>
                    <span class="cost-category-total"><%= formatCurrency(catData.total) %></span>
                    <span class="cost-category-pct"><%= formatPercent(catPct) %></span>
                  </div>
                </div>
              </div>
            <% }); %>
          <% } %>
          <div class="labour-dash-link">
            <a href="/labour">Adjust allocations â†’</a>
          </div>

        <% } else if (groupKey === 'fixed') { %>
          <% if (group._rawTotal > 0) { %>
            <div class="labour-dash-meta">
              All fixed accounts: <strong><%= formatCurrency(group._rawTotal) %></strong>
              &middot; This tab (<%= Math.round((group._tabPct || 0) * 100) %>%): <strong><%= formatCurrency(group.total) %></strong>
            </div>
          <% } %>
          <% Object.entries(group.categories).forEach(([catName, catData]) => { %>
            <%
              const catPct     = group.total > 0 ? (catData.total / group.total * 100) : 0;
              const distKey    = 'fixed:' + catName;
              const distRule   = distributions && distributions[distKey];
              const distMonths = distRule ? distRule.months : 1;
              const hasCarry   = catData._hasCarryOver;
              const safeId     = catName.replace(/[^a-z0-9]/gi, '_');
            %>
            <div class="cost-category">
              <div class="cost-category-header" onclick="toggleCategory('fixed-<%= safeId %>')">
                <span class="cost-category-name">
                  <%= catName %>
                  <% if (distMonths > 1) { %><span class="dist-badge">Ã·<%= distMonths %>mo</span><% } %>
                  <% if (hasCarry) { %><span class="dist-carry-badge" title="Includes carry-over from previous months">âŸ²</span><% } %>
                </span>
                <div class="cost-category-right">
                  <div class="mini-bar-wrap">
                    <div class="mini-bar<% if (hasCarry) { %> mini-bar-distributed<% } %>" style="width:<%= Math.min(catPct, 100) %>%"></div>
                  </div>
                  <span class="cost-category-total"><%= formatCurrency(catData.total) %></span>
                  <span class="cost-category-pct"><%= formatPercent(catPct) %></span>
                  <button class="cat-settings-btn" onclick="event.stopPropagation();toggleCatSettings('fixed','<%= safeId %>')" title="Distribution settings">âš™</button>
                </div>
              </div>
              <div class="cat-settings-panel hidden" id="cat-settings-fixed-<%= safeId %>">
                <div class="cat-settings-row">
                  <label>Distribute over</label>
                  <input type="number" class="dist-months-input" min="1" max="24" value="<%= distMonths %>"
                    id="dist-months-fixed-<%= safeId %>">
                  <span>months</span>
                  <button class="dist-save-btn" onclick="saveDistribution('fixed','<%= catName %>','<%= safeId %>',this)">Save</button>
                  <span class="dist-help">Set to 1 to show full cost each month.</span>
                </div>
              </div>
              <div class="cost-lines" id="lines-fixed-<%= safeId %>" style="display:none">
                <% catData.lines.forEach(line => { %>
                  <div class="cost-line<% if (line._distributed) { %> cost-line-distributed<% } %>">
                    <span class="cost-line-supplier"><%= line.supplierName %><% if (line._distributed) { %> <span class="dist-from-badge">carry-over</span><% } %></span>
                    <span class="cost-line-amount"><%= formatCurrency(line.amount) %></span>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
          <div class="labour-dash-link">
            <a href="/fixed-costs">Adjust allocations â†’</a>
          </div>

        <% } else { %>
          <% Object.entries(group.categories).forEach(([catName, catData]) => { %>
            <%
              const catPct     = group.total > 0 ? (catData.total / group.total * 100) : 0;
              const distKey    = groupKey + ':' + catName;
              const distRule   = distributions && distributions[distKey];
              const distMonths = distRule ? distRule.months : 1;
              const hasCarry   = catData._hasCarryOver;
              const safeId     = catName.replace(/[^a-z0-9]/gi, '_');
            %>
            <div class="cost-category">
              <div class="cost-category-header" onclick="toggleCategory('<%= groupKey %>-<%= safeId %>')">
                <span class="cost-category-name">
                  <%= catName %>
                  <% if (distMonths > 1) { %><span class="dist-badge">Ã·<%= distMonths %>mo</span><% } %>
                  <% if (hasCarry) { %><span class="dist-carry-badge" title="Includes carry-over from previous months">âŸ²</span><% } %>
                </span>
                <div class="cost-category-right">
                  <div class="mini-bar-wrap">
                    <div class="mini-bar<% if (hasCarry) { %> mini-bar-distributed<% } %>" style="width:<%= Math.min(catPct, 100) %>%"></div>
                  </div>
                  <span class="cost-category-total"><%= formatCurrency(catData.total) %></span>
                  <span class="cost-category-pct"><%= formatPercent(catPct) %></span>
                  <button class="cat-settings-btn" onclick="event.stopPropagation();toggleCatSettings('<%= groupKey %>','<%= safeId %>')" title="Distribution settings">âš™</button>
                </div>
              </div>
              <div class="cat-settings-panel hidden" id="cat-settings-<%= groupKey %>-<%= safeId %>">
                <div class="cat-settings-row">
                  <label>Distribute over</label>
                  <input type="number" class="dist-months-input" min="1" max="24" value="<%= distMonths %>"
                    id="dist-months-<%= groupKey %>-<%= safeId %>">
                  <span>months</span>
                  <button class="dist-save-btn" onclick="saveDistribution('<%= groupKey %>','<%= catName %>','<%= safeId %>',this)">Save</button>
                  <span class="dist-help">Set to 1 to show full cost each month.</span>
                </div>
              </div>
              <div class="cost-lines" id="lines-<%= groupKey %>-<%= safeId %>" style="display:none">
                <% catData.lines.forEach(line => { %>
                  <div class="cost-line<% if (line._distributed) { %> cost-line-distributed<% } %>">
                    <span class="cost-line-supplier"><%= line.supplierName %><% if (line._distributed) { %> <span class="dist-from-badge">carry-over</span><% } %></span>
                    <span class="cost-line-amount"><%= formatCurrency(line.amount) %></span>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  <% }); %>
</div>
<% } %>

<script>
function toggleCatSettings(groupKey, safeId) {
  var panel = document.getElementById('cat-settings-' + groupKey + '-' + safeId);
  if (panel) panel.classList.toggle('hidden');
}

function saveDistribution(groupKey, catName, safeId, btn) {
  var inp = document.getElementById('dist-months-' + groupKey + '-' + safeId);
  if (!inp) return;
  var months = Number(inp.value) || 1;
  var origText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'â€¦';
  fetch('/api/distribution', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ groupKey: groupKey, category: catName, months: months }),
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    btn.disabled = false;
    if (d.ok) {
      btn.textContent = 'âœ“ Saved';
      setTimeout(function() { location.reload(); }, 800);
    } else {
      btn.textContent = 'âœ—';
      setTimeout(function() { btn.textContent = origText; }, 2000);
    }
  })
  .catch(function() {
    btn.disabled = false;
    btn.textContent = 'âœ—';
    setTimeout(function() { btn.textContent = origText; }, 2000);
  });
}
</script>
